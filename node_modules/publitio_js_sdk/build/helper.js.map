{"version":3,"sources":["../src/helper.js"],"names":["uint32Max","Math","pow","runningInNode","window","FormData","require","Helper","obj","str","property","Object","prototype","hasOwnProperty","call","push","encodeURIComponent","join","min","max","hasCrypto","crypto","r","Promise","resolve","reject","then","randomBytes","readUInt32BE","getRandomValues","Uint32Array","random","x","floor","number","Array","slice","Date","now","getTime","pad","mtRand","MIN","MAX","args","url","key","secret","version","appendArguments","serialize","method","fetchService","callApi","catch","error","api_nonce","apiNonce","api_timestamp","timestamp","api_key","api_signature","sign","action","createUrl","dataOrStream","getDataFrom","data","formData","append","uploadFile","Buffer","from","on","chunk","concat","err","helper"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;;;;;;;;;;;AAEA,IAAMA,SAAS,GAAGC,IAAI,CAACC,GAAL,CAAS,CAAT,EAAY,EAAZ,CAAlB;AAEO,IAAMC,aAAa,GAAI,OAAOC,MAAP,KAAkB,WAAzC;;AAEP,IAAMC,QAAQ,GAAIF,aAAD,GAAkBG,OAAO;AAAC;AAAmC,WAApC,CAAzB,GAA4EF,MAAM,CAACC,QAApG;;IAEqBE,M;;;;;;;;;8BACRC,G,EAAK;AACd,UAAMC,GAAG,GAAG,EAAZ;;AACA,WAAK,IAAMC,QAAX,IAAuBF,GAAvB,EAA4B;AAC1B,YAAIG,MAAM,CAACC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqCN,GAArC,EAA0CE,QAA1C,CAAJ,EAAyD;AACvDD,UAAAA,GAAG,CAACM,IAAJ,WAAYC,kBAAkB,CAACN,QAAD,CAA9B,cAA4CM,kBAAkB,CAACR,GAAG,CAACE,QAAD,CAAJ,CAA9D;AACD;AACF;;AACD,aAAOD,GAAG,CAACQ,IAAJ,CAAS,GAAT,CAAP;AACD;;;2BAEOC,G,EAAKC,G,EAAK;AAChB,UAAMC,SAAS,GAAI,OAAOC,MAAP,KAAkB,WAArC;;AAEA,eAASC,CAAT,GAAa;AACX,eAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,cAAItB,aAAJ,EAAmB;AACjB;AAAA,qDAAuC,QAAvC;AAAA,eAAiDuB,IAAjD,CACE,UAAAL,MAAM;AAAA,qBAAIG,OAAO,CAACH,MAAM,CAACM,WAAP,CAAmB,CAAnB,EAAsBC,YAAtB,KAAuC5B,SAAxC,CAAX;AAAA,aADR;AAGD,WAJD,MAIO,IAAIoB,SAAJ,EAAe;AACpBI,YAAAA,OAAO,CAACH,MAAM,CAACQ,eAAP,CAAuB,IAAIC,WAAJ,CAAgB,CAAhB,CAAvB,EAA2C,CAA3C,IAAgD9B,SAAjD,CAAP;AACD,WAFM,MAEA;AACLwB,YAAAA,OAAO,CAACvB,IAAI,CAAC8B,MAAL,EAAD,CAAP;AACD;AACF,SAVM,CAAP;AAWD;;AAED,aAAOT,CAAC,GAAGI,IAAJ,CAAS,UAAAM,CAAC;AAAA,eAAI/B,IAAI,CAACgC,KAAL,CAAWD,CAAC,IAAIb,GAAG,GAAGD,GAAN,GAAY,CAAhB,CAAZ,IAAkCA,GAAtC;AAAA,OAAV,CAAP;AACD;;;wBAEIgB,M,EAAQzB,G,EAAK;AAChB,aAAO,CAACA,GAAG,GAAG0B,KAAK,CAACD,MAAD,CAAL,CAAcjB,IAAd,CAAmB,GAAnB,CAAP,EAAgCmB,KAAhC,CAAsC,CAAtC,EAAyCF,MAAzC,CAAP;AACD;;;gCAEY;AACX,UAAI,CAACG,IAAI,CAACC,GAAV,EAAe;AACbD,QAAAA,IAAI,CAACC,GAAL,GAAW,YAAM;AAAE,iBAAOrC,IAAI,CAACgC,KAAL,CAAW,IAAII,IAAJ,GAAWE,OAAX,KAAuB,IAAlC,CAAP;AAAgD,SAAnE;AACD;;AACD,aAAOtC,IAAI,CAACgC,KAAL,CAAWI,IAAI,CAACC,GAAL,KAAa,IAAxB,CAAP;AACD;;;+BAEW;AACV,aAAO,KAAKE,GAAL,CAAS,CAAT,EAAY,KAAKC,MAAL,CAAYC,cAAZ,EAAiBC,cAAjB,CAAZ,CAAP;AACD;;;8BAEU7B,I,EAA4C;AAAA,UAAtC8B,IAAsC,uEAA/B,EAA+B;AAAA,UAA3BC,GAA2B;AAAA,UAAtBC,GAAsB;AAAA,UAAjBC,MAAiB;AAAA,UAATC,OAAS;AACrDJ,MAAAA,IAAI,GAAG,KAAKK,eAAL,CAAqBL,IAArB,EAA2BE,GAA3B,EAAgCC,MAAhC,EAAwCC,OAAxC,CAAP;AACA,uBAAUH,GAAV,SAAgB/B,IAAhB,cAAwB,KAAKoC,SAAL,CAAeN,IAAf,CAAxB;AACD;;;4BAEQC,G,EAAKM,M,EAAQ;AACpB,aAAOC,oBAAaC,OAAb,CAAqBR,GAArB,EAA0BM,MAA1B,EACJG,KADI,CACE,UAACC,KAAD,EAAW;AAAE,cAAMA,KAAN;AAAa,OAD5B,CAAP;AAED;;;oCAEgBX,I,EAAME,G,EAAKC,M,EAAQ;AAClCH,MAAAA,IAAI,CAACY,SAAL,GAAiB,KAAKC,QAAL,EAAjB;AACAb,MAAAA,IAAI,CAACc,aAAL,GAAqB,KAAKC,SAAL,EAArB;AACAf,MAAAA,IAAI,CAACgB,OAAL,GAAed,GAAf;AACAF,MAAAA,IAAI,CAACiB,aAAL,GAAqB,KAAKC,IAAL,CAAUlB,IAAV,EAAgBG,MAAhB,CAArB;AAEA,aAAOH,IAAP;AACD;;;yBAEKA,I,EAAMG,M,EAAQ;AAClB,aAAO,4BAAQH,IAAI,CAACc,aAAb,SAA6Bd,IAAI,CAACY,SAAlC,SAA8CT,MAA9C,EAAP;AACD;;;0CAEsBgB,M,EAAQnB,I,EAAMC,G,EAAKC,G,EAAKC,M,EAAQC,O,EAAS;AAC9D,UAAIe,MAAM,KAAK,MAAf,EAAuB;AACrBlB,QAAAA,GAAG,GAAG,KAAKmB,SAAL,CAAe,eAAf,EAAgCpB,IAAhC,EAAsCC,GAAtC,EAA2CC,GAA3C,EAAgDC,MAAhD,EAAwDC,OAAxD,CAAN;AACD,OAFD,MAEO,IAAIe,MAAM,KAAK,WAAf,EAA4B;AACjClB,QAAAA,GAAG,GAAG,KAAKmB,SAAL,CAAe,oBAAf,EAAqCpB,IAArC,EAA2CC,GAA3C,EAAgDC,GAAhD,EAAqDC,MAArD,EAA6DC,OAA7D,CAAN;AACD;;AACD,aAAOH,GAAP;AACD,K,CAED;;;;+BACYoB,Y,EAAcpB,G,EAAK;AAC7B,aAAO,KAAKqB,WAAL,CAAiBD,YAAjB,EAA+BvC,IAA/B,CAAoC,UAAAyC,IAAI,EAAI;AACjD,YAAMC,QAAQ,GAAG,IAAI/D,QAAJ,EAAjB;AACA+D,QAAAA,QAAQ,CAACC,MAAT,CAAgB,MAAhB,EAAwBF,IAAxB,EAA8B,MAA9B;AACA,eAAOf,oBAAakB,UAAb,CAAwBF,QAAxB,EAAkCvB,GAAlC,CAAP;AACD,OAJM,CAAP;AAKD;;;gCAEYoB,Y,EAAc;AACzB,aAAO,IAAI1C,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,YAAI,CAACtB,aAAD,IAAkB8D,YAAY,YAAYM,MAA1C,IAAoD,OAAON,YAAP,KAAwB,QAAhF,EAA0F;AACxFzC,UAAAA,OAAO,CAACyC,YAAD,CAAP;AACD,SAFD,MAEO;AACL,cAAIE,IAAI,GAAGI,MAAM,CAACC,IAAP,CAAY,EAAZ,CAAX;AACAP,UAAAA,YAAY,CAACQ,EAAb,CAAgB,MAAhB,EAAwB,UAAAC,KAAK,EAAI;AAAEP,YAAAA,IAAI,GAAGI,MAAM,CAACI,MAAP,CAAc,CAACR,IAAD,EAAOO,KAAP,CAAd,CAAP;AAAqC,WAAxE;AACAT,UAAAA,YAAY,CAACQ,EAAb,CAAgB,KAAhB,EAAuB;AAAA,mBAAMjD,OAAO,CAAC+C,MAAM,CAACC,IAAP,CAAYL,IAAZ,CAAD,CAAb;AAAA,WAAvB;AACAF,UAAAA,YAAY,CAACQ,EAAb,CAAgB,OAAhB,EAAyB,UAAAG,GAAG;AAAA,mBAAInD,MAAM,CAACmD,GAAD,CAAV;AAAA,WAA5B;AACD;AACF,OATM,CAAP;AAUD;;;;;;;AAGI,IAAMC,MAAM,GAAG,IAAItE,MAAJ,EAAf","sourcesContent":["import SHA1 from 'crypto-js/sha1'\nimport { MIN, MAX } from './constants'\nimport { fetchService } from './fetch'\n\nconst uint32Max = Math.pow(2, 32)\n\nexport const runningInNode = (typeof window === 'undefined')\n\nconst FormData = (runningInNode) ? require(/* webpackExclude: /form-data$/ */ 'form-data') : window.FormData\n\nexport default class Helper {\n  serialize (obj) {\n    const str = []\n    for (const property in obj) {\n      if (Object.prototype.hasOwnProperty.call(obj, property)) {\n        str.push(`${encodeURIComponent(property)}=${encodeURIComponent(obj[property])}`)\n      }\n    }\n    return str.join('&')\n  }\n\n  mtRand (min, max) {\n    const hasCrypto = (typeof crypto !== 'undefined')\n\n    function r() {\n      return new Promise((resolve, reject) => {\n        if (runningInNode) {\n          import(/* webpackExclude: /crypto$/ */ 'crypto').then(\n            crypto => resolve(crypto.randomBytes(8).readUInt32BE() / uint32Max)\n          )\n        } else if (hasCrypto) {\n          resolve(crypto.getRandomValues(new Uint32Array(1))[0] / uint32Max)\n        } else {\n          resolve(Math.random())\n        }\n      })\n    }\n\n    return r().then(x => Math.floor(x * (max - min + 1)) + min)\n  }\n\n  pad (number, str) {\n    return (str + Array(number).join('0')).slice(0, number)\n  }\n\n  timestamp () {\n    if (!Date.now) {\n      Date.now = () => { return Math.floor(new Date().getTime() / 1000) }\n    }\n    return Math.floor(Date.now() / 1000)\n  }\n\n  apiNonce () {\n    return this.pad(8, this.mtRand(MIN, MAX))\n  }\n\n  createUrl (call, args = [], url, key, secret, version) {\n    args = this.appendArguments(args, key, secret, version)\n    return `${url}${call}?${this.serialize(args)}`\n  }\n\n  callApi (url, method) {\n    return fetchService.callApi(url, method)\n      .catch((error) => { throw error })\n  }\n\n  appendArguments (args, key, secret) {\n    args.api_nonce = this.apiNonce()\n    args.api_timestamp = this.timestamp()\n    args.api_key = key\n    args.api_signature = this.sign(args, secret)\n\n    return args\n  }\n\n  sign (args, secret) {\n    return SHA1(`${args.api_timestamp}${args.api_nonce}${secret}`)\n  }\n\n  getUrlForFileCreation (action, args, url, key, secret, version) {\n    if (action === 'file') {\n      url = this.createUrl('/files/create', args, url, key, secret, version)\n    } else if (action === 'watermark') {\n      url = this.createUrl('/watermarks/create', args, url, key, secret, version)\n    }\n    return url\n  }\n\n  // dataOrStream can be a Node Buffer, stream, or a string or Blob (or Blob subclasses such as File) in the browser.\n  uploadFile (dataOrStream, url) {\n    return this.getDataFrom(dataOrStream).then(data => {\n      const formData = new FormData()\n      formData.append('file', data, 'file')\n      return fetchService.uploadFile(formData, url)\n    })\n  }\n\n  getDataFrom (dataOrStream) {\n    return new Promise((resolve, reject) => {\n      if (!runningInNode || dataOrStream instanceof Buffer || typeof dataOrStream === 'string') {\n        resolve(dataOrStream)\n      } else {\n        let data = Buffer.from([])\n        dataOrStream.on('data', chunk => { data = Buffer.concat([data, chunk]) })\n        dataOrStream.on('end', () => resolve(Buffer.from(data)))\n        dataOrStream.on('error', err => reject(err))\n      }\n    })\n  }\n}\n\nexport const helper = new Helper()\n"],"file":"helper.js"}